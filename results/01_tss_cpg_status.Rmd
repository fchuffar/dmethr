---
title: "CpG status of region surrounding TSS"
author: "Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
---



```{r, echo=FALSE, eval=TRUE, label="loading libraries"}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide")
```

```{r params}
source("common.R")
step = 100
nb_rnd_feat = 2000
ud_str = 2500
up_str = dwn_str = ud_str
prefix = "tss"
prefix = paste0(prefix, "_", up_str, "_", dwn_str, "_", step, "_", nb_rnd_feat, "")
```

```{r globals variables}
hg38_chrom_sizes  = read.table("~/projects/genes/hg38.chrom.sizes", stringsAsFactors=FALSE)
rownames(hg38_chrom_sizes) = hg38_chrom_sizes[,1]
```

# Purpose

The main goal of this study is to define CpG status of genome region around TSS by computing CpG density from genome sequence.

It happends in 2 steps : 
  
  - extract genome sequence around TSS
  - count the number of CG in the sequence


# Features

```{r}
feats = readRDS("~/projects/genes/bed_grch38_epimeddb.rds")
head(feats)
dim(feats)
```

```{r filtering anbd downsampling}
# Filtering according to...
# feats = feats[
#   # feats$score>5 &
#   feats$len<5000
#   ,]
# plot_feat_den(feats$len, feats$score, xlim, ylim)

# Downsampling
if (nb_rnd_feat > 0) {
  dim(feats)
  set.seed(1)
  feats = feats[sort(sample(1:nrow(feats), min(nrow(feats), nb_rnd_feat))),]
  dim(feats)  
  # plot_feat_den(feats$len, feats$score, xlim, ylim, xlab="length", ylab="#probes")
}
```


# CpG enrichment of features

```{r Extract DNA sequences of TSS +/- ud_str bp}
seq_filename = paste0("seq_", prefix, ".rds")
if (!file.exists(seq_filename)) {
  seq = get_seq_from_bed(feats, up_str, dwn_str, hg38_chrom_sizes)
  saveRDS(seq, seq_filename)
}
seq = readRDS(seq_filename)
length(seq)
```

```{r Slice DNA sequences and count CpG density}
# mat_filename = paste0("mat_", prefix, ".rds")
# if (!file.exists(mat_filename)) {
  mat = get_matbin_from_seq(seq, up_str, dwn_str, step)
#   saveRDS(mat, mat_filename)
# }
# mat = readRDS(mat_filename)
head(mat)
dim(mat)

binmax = apply(mat, 1, function(l) {
  maxIndex = which(l==max(l))[1]
})
head(binmax)
feats$binmax = NA
feats[names(binmax),]$binmax = binmax
head(feats)
```



CpG density ( nb. of CpG / length of sequence) is computed in sequence of TSS +/-`r ud_str/1000`kb sliced into `r step` bins.

TSS of 1000 random feats is represented there. It shows a CpG enrichment aoroud TSS.

```{r label="heatmap for 1000 rnd feats"}
set.seed(1)
data = mat[order(binmax[rownames(mat)]),]
data = data[sort(sample(1:nrow(data), min(nrow(data), 1000))), ]
colors=c("black",  "red")
cols = colorRampPalette(colors)(20)
rownames(data) = NULL
gplots::heatmap.2(data, Rowv=NULL,  Colv=NULL,  dendrogram="none", trace="none", col=cols, main=paste0("CpG enrichment (feats +/-", ud_str/1000, "kb, 1000 rnd genes)"), xaxt="n", mar=c(8,5))
```


CpG density distribution is represented there. 

It shows that MOST OF TSS are CpG enriched compared to random sequence.  

It also shows that NOT ALL TSS are are CpG enriched.

```{r label="CpG density distribution"}
nb_cpg_rnd_filename = paste0("nb_cpg_rnd_TSS_", up_str, "_", dwn_str, ".rds")
if (!file.exists(nb_cpg_rnd_filename)) {
  idx = sample(1:22, 5000, replace=TRUE)
  set.seed(1)
  pos = sapply(hg38_chrom_sizes[idx,2], function(e) round(runif(1, 15000, e-15000)))
  rnd_feat = data.frame(hg38_chrom_sizes[idx,1], pos, stringsAsFactors=FALSE)
  nb_cpg_rnd = epimedtools::monitored_apply(mod=10, rnd_feat, 1, function(feat) {
    chr = feat[[1]]
    tss = as.numeric(feat[[2]])
    bef = up_str
    aft = dwn_str
    beg = max(1,tss - bef)
    end = min(hg38_chrom_sizes[chr,2], tss + aft)
    str = as.character(BSgenome::getSeq(BSgenome.Hsapiens.UCSC.hg38::Hsapiens, chr, beg, end))
    # stringr::str_count(str, "CG") / nchar(str)
    lnn = nchar(gsub("N", "", str))
    # denom = l - lnn
    if (lnn==0) {
      return(NA)
    } else {
      return(stringr::str_count(str, "CG") / lnn)
    }
  })
  saveRDS(nb_cpg_rnd, nb_cpg_rnd_filename)
}
nb_cpg_rnd = readRDS(nb_cpg_rnd_filename)

nb_cpg_tss = apply(mat, 1, mean, na.rm=TRUE)

layout(matrix(1:2,1), respect=TRUE)
plot(density(nb_cpg_tss),ylim=c(0,100), main="CpG enrichment distribution", xlab="CpG density", ylab="", yaxt="n")
lines(density(nb_cpg_rnd, na.rm=TRUE), col=2)
legend("topright", c(paste0("tss +/-", ud_str/1000, "kb"), paste0("rnd pos +/-", ud_str/1000, "kb")), col=1:2, lty=1)
plot(density(log10(nb_cpg_tss)), main="CpG enrichment distribution", xlab="log10(CpG density)", ylab="", yaxt="n")
lines(density(log10(nb_cpg_rnd), na.rm=TRUE), col=2)
legend("topright", c(paste0("tss +/-", ud_str/1000, "kb"), paste0("rnd pos +/-", ud_str/1000, "kb")), col=1:2, lty=1)
```


Then we clustering TSS according to there sliced CpG density

PCA on TSS +/-`r ud_str/1000`kb sliced into `r step`b bins is performed.

Component 1 discriminates CpG rich and poor TSS.

```{r label="PCA on mat"}
mat = mat[!apply(is.na(mat), 1, any),] 
pca = prcomp(mat, scale=FALSE)
v = pca$sdev * pca$sdev
p = v / sum(v) * 100

layout(matrix(1:2,1), respect=TRUE)
barplot(p)
i = 1
plot(density(pca$x[,i]), main=paste0("PC", i, "(", signif(p[i], 3), "%)"))
abline(v=-0.04)

idx = pca$x[,1] < -0.04

plot(apply(mat[idx,], 2, mean), type="l", ylim=c(0, .13), col=1, main="CpG enrichment", xaxt="n")
lines(apply(mat[!idx,], 2, mean), col=2)
axis(1, at=c(0, ncol(mat)/2, ncol(mat)), label=c(paste0("TSS -", ud_str/1000, "kb"), "TSS", paste0("TSS +", ud_str/1000, "kb")))
legend("topright", legend=c(paste0(sum(idx), " feats"), paste0(sum(!idx), " feats")), col=1:2, lty=1)


# layout(matrix(1:6,2), respect=TRUE)
# for(i in 1:6) {
#   barplot(pca$rotation[,i], main=paste("contrib PC",i))
# }

# layout(matrix(1:2,1), respect=TRUE)
# i=1
# j=2
# plot(pca$x[,i], pca$x[,j], xlab=paste0("PC", i, "(", signif(p[i], 3), "%)"), ylab=paste0("PC", j, "(", signif(p[j], 3), "%)"), pch=16, col=adjustcolor(1, alpha.f=0.05),
#   main=paste0("PCA (TSS +/-", ud_str/1000, "kb, ", nrow(mat), " feats)")
# )
# i=1
# j=3
# plot(pca$x[,i], pca$x[,j], xlab=paste0("PC", i, "(", signif(p[i], 3), "%)"), ylab=paste0("PC", j, "(", signif(p[j], 3), "%)"), pch=16, col=adjustcolor(1, alpha.f=0.05),
#   main=paste0("PCA (TSS +/-", ud_str/1000, "kb, ", nrow(mat), " feats)")
# )

feats$tss_cpg_status  = NA
feats[names(idx)[!idx],]$tss_cpg_status = "cpg_rich"
feats[names(idx)[idx],]$tss_cpg_status = "cpg_poor"
table(feats$tss_cpg_status)
feats$cpg_density = NA
feats[rownames(mat),]$cpg_density = apply(mat, 1, mean)
# WriteXLS::WriteXLS(feats, "feats_cpg_status.xls")
```

# Session Information

```{r, results="verbatim"}
sessionInfo()
```


