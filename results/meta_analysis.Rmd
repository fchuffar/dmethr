---
title: "`demethr` Meta analysis"
author: "Florence Pittion, Florent Chuffart"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true    
  pdf_document:
    keep_tex: true
---



```{r, echo=FALSE, eval=TRUE}
knitr::opts_chunk$set(collapse=TRUE, comment = "#>", fig.width=9, fig.height=6, eval=TRUE, echo=FALSE, results="hide", warning=FALSE)
source("common.R")
```

# Step 1

```{r}
tcga_projects = c("TCGA-LUSC")
#, "TCGA-LUAD")

nb_rnd_feat = 0
ud_strs = c(2500, 1000, 500, 250)
# feature_pretreatments = c("raw", "cen")
feature_pretreatments = c("cen")
feature_pretreatments = c("raw")

reducer_func2_names = c("mean", "max", "min")

gses = c(
  "GSE45332", 
  "GSE5816", 
  "GSE14315"#, 
  # "GSE25427", 
  # "GSE22250"
  )

feats_filename = "feats_raw_2500_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_2500 = rownames(feats)[feats$cpg_status %in% "rich"]
idx_cpg_rich_2500_notna = rownames(feats)[feats$cpg_status %in% "rich"& !is.na(feats$meanmeth)]
feats_filename = "feats_raw_1000_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_1000 = rownames(feats)[feats$cpg_status %in% "rich"]
idx_cpg_rich_1000_notna = rownames(feats)[feats$cpg_status %in% "rich"& !is.na(feats$meanmeth)]
feats_filename = "feats_raw_500_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_500 = rownames(feats)[feats$cpg_status %in% "rich"]
idx_cpg_rich_500_notna = rownames(feats)[feats$cpg_status %in% "rich"& !is.na(feats$meanmeth)]
feats_filename = "feats_raw_250_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_250 = rownames(feats)[feats$cpg_status %in% "rich"]
idx_cpg_rich_250_notna = rownames(feats)[feats$cpg_status %in% "rich"& !is.na(feats$meanmeth)]



idx_cpg_rich_common = intersect(
  intersect(
    intersect(
      idx_cpg_rich_2500, 
      idx_cpg_rich_1000),
      idx_cpg_rich_500),
      idx_cpg_rich_250
)
stat1 = data.frame( 
  grp = c(
    "2500",
    "1000",
    "500",
    "250",
    "common"
  ),
  nb_cpg_rich = c(
    length(idx_cpg_rich_2500),
    length(idx_cpg_rich_1000),
    length(idx_cpg_rich_500),
    length(idx_cpg_rich_250),
    length(idx_cpg_rich_common)
  )
)
stat1$grp = factor(stat1$grp, levels=c("250","500","1000","2500", "common"))
layout(1, respect=TRUE)
boxplot(nb_cpg_rich~grp, stat1, ylim=c(0,20000), xlab="ud_str", main="CpG rich genes")
```


# Step 2: Mean methylation in healthy tissues


```{r}
idx_cpg_rich_common_notna = intersect(
  intersect(
    intersect(
      idx_cpg_rich_2500_notna, 
      idx_cpg_rich_1000_notna),
      idx_cpg_rich_500_notna),
      idx_cpg_rich_250_notna
)
stat1 = data.frame( 
  grp = c(
    "2500",
    "1000",
    "500",
    "250",
    "common"
  ),
  nb_cpg_rich = c(
    length(idx_cpg_rich_2500_notna),
    length(idx_cpg_rich_1000_notna),
    length(idx_cpg_rich_500_notna),
    length(idx_cpg_rich_250_notna),
    length(idx_cpg_rich_common_notna)
  )
)
stat1$grp = factor(stat1$grp, levels=c("250","500","1000","2500", "common"))
layout(1, respect=TRUE)

boxplot(nb_cpg_rich~grp, stat1, ylim=c(0,20000), xlab="ud_str", main="CpG rich genes, meanmeth not NA")


```





```{r, fig.height=9}
layout(1, respect=TRUE)
foo = sapply(c(
  "feats_raw_250_0_mean.xlsx", 
  "feats_raw_500_0_mean.xlsx", 
  "feats_raw_1000_0_mean.xlsx", 
  "feats_raw_2500_0_mean.xlsx",
  "feats_raw_250_0_max.xlsx", 
  "feats_raw_500_0_max.xlsx", 
  "feats_raw_1000_0_max.xlsx", 
  "feats_raw_2500_0_max.xlsx"
  ), function(feats_filename){
  feats = mread.xlsx(feats_filename)
  rownames(feats) = feats$gene_symbol
  head(feats)
  sum(!is.na(feats[idx_cpg_rich_common,]$meanmeth))
  ret = feats[idx_cpg_rich_common,]$meanmeth
  names(ret) = idx_cpg_rich_common
  return(ret)
}) 
idx_genes = rownames(foo)[!apply(is.na(foo), 1, any)]
foo = foo[idx_genes,]
head(foo)

pairs(foo, pch=".", main="Mean methylation in healthy tissues")
```

# Step 3 

```{r eval=TRUE}
stats = NULL
for (feature_pretreatment in feature_pretreatments) {
  print(feature_pretreatment)
  for (ud_str in ud_strs) {
    print(ud_str)
    for (reducer_func2_name in reducer_func2_names) {
      print(reducer_func2_name)
      
      prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_", reducer_func2_name)
      feats_filename = paste0("feats_", prefix3, ".xlsx")
      print(feats_filename)
      feats = mread.xlsx (feats_filename)
        
      tmp_list = list(
        feature_pretreatment = feature_pretreatment, 
        ud_str = ud_str, 
        reducer_func2_name = reducer_func2_name,
        nb_rnd_feat = nb_rnd_feat, 
        nb_cpg_rich = sum(feats$cpg_status %in% "rich"),
        nb_methpp =   sum(feats$methplusplus)
      )

      for (gse in gses) {
        print(gse)
        gene_set = rownames(feats)[feats[["methplusplus"]]]
        expression_vector = feats[,paste0("l2fc_", gse)]
        names(expression_vector) = rownames(feats)
        expression_vector = expression_vector[!is.na(expression_vector)]
        utest = wilcox.test(expression_vector~ifelse(names(expression_vector)%in%gene_set, "methplusplus", "others"), las=2)
        pv = utest$p.value
        print(pv)
        tmp_list[[paste0("utest_pval_", gse)]] = pv
      }

      
      if (is.null(stats)) {
        stats = tmp_list
      } else{
        stats = rbind(stats, tmp_list)
      }
    }
  }
}
stats
stats[,1]
stats = data.frame(lapply(data.frame(stats, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)
stats[,1]


stats = stats[stats$feature_pretreatment=="raw",]
gses = c(
  "GSE45332", 
  "GSE5816", 
  "GSE14315", 
  "GSE25427", 
  "GSE22250")
gses = gses [1:3]
feature_pretreatment = feature_pretreatment[1]

layout(1, respect = TRUE)
plot(0,0,col=0, xlim=range(stats$ud_str), ylim=c(0,60), xlab="up/downstrean TSS window size", ylab="methplusplus enrichment Mann-Whitney")
for (i in 1:length(gses)) {
  gse = gses[i]
  points(stats$ud_str, -log10(stats[[paste0("utest_pval_",gse)]]), 
       col=i, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2))
  for (feature_pretreatment in feature_pretreatments) {
    for (reducer_func2_name in reducer_func2_names) {
      tmp_idx = stats$reducer_func2_name==reducer_func2_name & stats$feature_pretreatment==feature_pretreatment
      lines(stats[tmp_idx,]$ud_str, -log10(stats[tmp_idx, paste0("utest_pval_",gse)]), 
        pch=ifelse(reducer_func2_name=="mean", 1, 2),
        lty=ifelse(feature_pretreatment=="raw", 1, 2),
        col=i
      )
    }
  }
} 
legend("topleft", 
  c(gses, "method raw", "method centered", "method mean", "method max"), 
  col=c(1:length(gses), 1, 1, 1, 1), 
  lty=c(rep(1, length(gses)), 1:2, 0,0), 
  pch=c(rep(NA, length(gses)), NA,NA, 1,2)
)
```





```{r eval=FALSE}
feats_filename = "feats_raw_2500_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_2500_common = intersect (idx_cpg_rich_2500, idx_cpg_rich_common)
meanmeth_2500 = feats[idx_cpg_rich_2500_common,]$meanmeth
feats_filename = "feats_raw_1000_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_1000_common = intersect (idx_cpg_rich_1000, idx_cpg_rich_common)
meanmeth_1000 = feats[idx_cpg_rich_1000_common,]$meanmeth
feats_filename = "feats_raw_500_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_500_common = intersect (idx_cpg_rich_500, idx_cpg_rich_common)
meanmeth_500 = feats[idx_cpg_rich_500_common,]$meanmeth
feats_filename = "feats_raw_250_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_250_common = intersect (idx_cpg_rich_250, idx_cpg_rich_common)
meanmeth_250 = feats[idx_cpg_rich_250_common,]$meanmeth


data_meanmeth = data.frame(meanmeth_2500,meanmeth_1000,meanmeth_500,meanmeth_250)
pairs(data_meanmeth)



```



```{r eval=FALSE}
feats_filename = "feats_raw_2500_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_2500_common = intersect (idx_cpg_rich_2500, idx_cpg_rich_common)
meanmeth_2500 = feats[idx_cpg_rich_2500_common,]$meanmeth
feats_filename = "feats_raw_1000_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_1000_common = intersect (idx_cpg_rich_1000, idx_cpg_rich_common)
meanmeth_1000 = feats[idx_cpg_rich_1000_common,]$meanmeth
feats_filename = "feats_raw_500_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_500_common = intersect (idx_cpg_rich_500, idx_cpg_rich_common)
meanmeth_500 = feats[idx_cpg_rich_500_common,]$meanmeth
feats_filename = "feats_raw_250_0_max.xlsx"
feats = mread.xlsx(feats_filename)
rownames(feats) = feats$gene_symbol
idx_cpg_rich_250_common = intersect (idx_cpg_rich_250, idx_cpg_rich_common)
meanmeth_250 = feats[idx_cpg_rich_250_common,]$meanmeth


data_meanmeth = data.frame(meanmeth_2500,meanmeth_1000,meanmeth_500,meanmeth_250)
pairs(data_meanmeth)


```














```{r eval=FALSE}
if (!exists("mread.xlsx")) {mread.xlsx = memoise::memoise(openxlsx::read.xlsx)}

stats = NULL
for (feature_pretreatment in feature_pretreatments) {
  print(feature_pretreatment)
  for (ud_str in ud_strs) {
    print(ud_str)
    for (reducer_func2_name in reducer_func2_names) {
      print(reducer_func2_name)
      
      prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_", reducer_func2_name)
      feats_filename = paste0("feats_", prefix3, ".xlsx")
      print(feats_filename)
      feats = mread.xlsx(feats_filename)
        
      tmp_list = list(
        feature_pretreatment = feature_pretreatment, 
        ud_str = ud_str, 
        reducer_func2_name = reducer_func2_name,
        nb_rnd_feat = nb_rnd_feat, 
        nb_cpg_rich = sum(feats$cpg_status %in% "rich"),
        nb_methpp =   sum(feats$methplusplus)
      )

      for (gse in gses) {
        print(gse)
        gene_set = rownames(feats)[feats[["methplusplus"]]]
        expression_vector = feats[,paste0("l2fc_", gse)]
        names(expression_vector) = rownames(feats)
        expression_vector = expression_vector[!is.na(expression_vector)]
        utest = wilcox.test(expression_vector~ifelse(names(expression_vector)%in%gene_set, "methplusplus", "others"), las=2)
        pv = utest$p.value
        print(pv)
        tmp_list[[paste0("utest_pval_", gse)]] = pv
      }

      
      if (is.null(stats)) {
        stats = tmp_list
      } else{
        stats = rbind(stats, tmp_list)
      }
    }
  }
}
stats
stats[,1]
stats = data.frame(lapply(data.frame(stats, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)
stats[,1]



layout(matrix(1:2,1), respect = TRUE)
plot(0,0,col=0, xlim=range(stats$ud_str), ylim=c(0,70), xlab="ud_str", ylab="-log10(pval_utest)")
for (i in 1:length(gses)) {
  gse = gses[i]
  points(stats$ud_str, -log10(stats[[paste0("utest_pval_",gse)]]), 
       col=i, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2))
  for (reducer_func2_name in reducer_func2_names) {
    lines(stats[stats$reducer_func2_name==reducer_func2_name,]$ud_str, -log10(stats[stats$reducer_func2_name==reducer_func2_name, paste0("utest_pval_",gse)]), 
           col=i, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2))
  }
} 
plot(stats$ud_str, stats$nb_methpp, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2), xlab = "ud_str", ylab = "nbgenes methplusplus")
for (reducer_func2_name in reducer_func2_names) {
    lines(stats[stats$reducer_func2_name==reducer_func2_name,]$ud_str, stats[stats$reducer_func2_name==reducer_func2_name,]$nb_methpp)
}

```


```{r, eval=FALSE}

layout(matrix(1:4, 2), respect=TRUE)
beta_reg = c()
for(ud_str in ud_strs){
    reducer_func2_name = "mean"
    feature_pretreatment = "raw"
    prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_", reducer_func2_name)
    feats_raw = openxlsx::read.xlsx (paste0("feats_", prefix3, ".xlsx"))
    feature_pretreatment = "cen"
    prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_", reducer_func2_name)
    feats_cen = openxlsx::read.xlsx (paste0("feats_", prefix3, ".xlsx"))
    #plot(jitter(feats_raw$nb_probes), jitter(feats_cen$nb_probes), main=ud_str)
    #abline(a=0, b=1)

    X = feats_cen$nb_probes
    Y = feats_raw$nb_probes
    reg = lm(X~Y)
    plot(X, Y, main=ud_str, xlab="raw", ylab="center")
    abline(reg, col = 2)
    abline(a=0, b=1, lty=2, col="grey")
    beta_reg = c(beta_reg, reg$coefficients[[2]])
}
beta_reg

```


# Effect of seq lenght and max/mean reducer function


```{r eval=FALSE}
if (!exists("mread.xlsx")) {mread.xlsx = memoise::memoise(openxlsx::read.xlsx)}
 feature_pretreatments = c("raw")
  
stats = NULL
for (feature_pretreatment in feature_pretreatments) {
  print(feature_pretreatment)
  for (ud_str in ud_strs) {
    print(ud_str)
    for (reducer_func2_name in reducer_func2_names) {
      print(reducer_func2_name)
      
      prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_", reducer_func2_name)
      feats_filename = paste0("feats_", prefix3, ".xlsx")
      print(feats_filename)
      feats = mread.xlsx (feats_filename)
        
      tmp_list = list(
        feature_pretreatment = feature_pretreatment, 
        ud_str = ud_str, 
        reducer_func2_name = reducer_func2_name,
        nb_rnd_feat = nb_rnd_feat, 
        nb_cpg_rich = sum(feats$cpg_status %in% "rich"),
        nb_methpp =   sum(feats$methplusplus)
      )

      for (gse in gses) {
        print(gse)
        gene_set = rownames(feats)[feats[["methplusplus"]]]
        expression_vector = feats[,paste0("l2fc_", gse)]
        names(expression_vector) = rownames(feats)
        expression_vector = expression_vector[!is.na(expression_vector)]
        utest = wilcox.test(expression_vector~ifelse(names(expression_vector)%in%gene_set, "methplusplus", "others"), las=2)
        pv = utest$p.value
        print(pv)
        tmp_list[[paste0("utest_pval_", gse)]] = pv
      }

      
      if (is.null(stats)) {
        stats = tmp_list
      } else{
        stats = rbind(stats, tmp_list)
      }
    }
  }
}
stats
stats[,1]
stats = data.frame(lapply(data.frame(stats, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)
stats[,1]



layout(matrix(1:2,1), respect = TRUE)
plot(0,0,col=0, xlim=range(stats$ud_str), ylim=c(0,70), xlab="ud_str", ylab="-log10(pval_utest)")
for (i in 1:length(gses)) {
  gse = gses[i]
  points(stats$ud_str, -log10(stats[[paste0("utest_pval_",gse)]]), 
       col=i, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2))
  for (reducer_func2_name in reducer_func2_names) {
    lines(stats[stats$reducer_func2_name==reducer_func2_name,]$ud_str, -log10(stats[stats$reducer_func2_name==reducer_func2_name, paste0("utest_pval_",gse)]), 
           col=i, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2))
  }
} 
plot(stats$ud_str, stats$nb_methpp, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2), xlab = "ud_str", ylab = "nbgenes methplusplus")
for (reducer_func2_name in reducer_func2_names) {
    lines(stats[stats$reducer_func2_name==reducer_func2_name,]$ud_str, stats[stats$reducer_func2_name==reducer_func2_name,]$nb_methpp)
}

```





```{r, eval = FALSE}
 feature_pretreatments = c("cen")
  
stats = NULL
for (feature_pretreatment in feature_pretreatments) {
  print(feature_pretreatment)
  for (ud_str in ud_strs) {
    print(ud_str)
    for (reducer_func2_name in reducer_func2_names) {
      print(reducer_func2_name)
      
      prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_", reducer_func2_name)
      feats_filename = paste0("feats_", prefix3, ".xlsx")
      print(feats_filename)
      feats = mread.xlsx (feats_filename)
        
      tmp_list = list(
        feature_pretreatment = feature_pretreatment, 
        ud_str = ud_str, 
        reducer_func2_name = reducer_func2_name,
        nb_rnd_feat = nb_rnd_feat, 
        nb_cpg_rich = sum(feats$cpg_status %in% "rich"),
        nb_methpp =   sum(feats$methplusplus)
      )

      for (gse in gses) {
        print(gse)
        gene_set = rownames(feats)[feats[["methplusplus"]]]
        expression_vector = feats[,paste0("l2fc_", gse)]
        names(expression_vector) = rownames(feats)
        expression_vector = expression_vector[!is.na(expression_vector)]
        utest = wilcox.test(expression_vector~ifelse(names(expression_vector)%in%gene_set, "methplusplus", "others"), las=2)
        pv = utest$p.value
        print(pv)
        tmp_list[[paste0("utest_pval_", gse)]] = pv
      }

      
      if (is.null(stats)) {
        stats = tmp_list
      } else{
        stats = rbind(stats, tmp_list)
      }
    }
  }
}
stats
stats = data.frame(lapply(data.frame(stats, stringsAsFactors=FALSE), unlist), stringsAsFactors=FALSE)
stats[,1]



layout(matrix(1:2,1), respect = TRUE)
plot(0,0,col=0, xlim=range(stats$ud_str), ylim=c(0,70), xlab="ud_str", ylab="-log10(pval_utest)")
for (i in 1:length(gses)) {
  gse = gses[i]
  points(stats$ud_str, -log10(stats[[paste0("utest_pval_",gse)]]), 
       col=i, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2))
  for (reducer_func2_name in reducer_func2_names) {
    lines(stats[stats$reducer_func2_name==reducer_func2_name,]$ud_str, -log10(stats[stats$reducer_func2_name==reducer_func2_name, paste0("utest_pval_",gse)]), 
           col=i, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2))
  }
} 
plot(stats$ud_str, stats$nb_methpp, pch=ifelse(stats[["reducer_func2_name"]]=="mean", 1, 2), xlab = "ud_str", ylab = "nbgenes methplusplus")
for (reducer_func2_name in reducer_func2_names) {
    lines(stats[stats$reducer_func2_name==reducer_func2_name,]$ud_str, stats[stats$reducer_func2_name==reducer_func2_name,]$nb_methpp)
}

```

# gene intersection

```{r eval = FALSE}
# gses = c(
#   "GSE45332", 
#   "GSE5816", 
#   "GSE14315")
feature_pretreatments = c("raw")
ud_strs = c(2500, 1000, 500, 250)


inter=data.frame()
#for (gse in gses) {
  
  for (ud_str in ud_strs) {
    print(ud_str)
    print(reducer_func2_name)
    
    prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_mean")
    feats_filename = paste0("feats_", prefix3, ".xlsx")
    print(feats_filename)
    feats_mean = mread.xlsx (feats_filename)
    
    prefix3 = paste0(feature_pretreatment, "_", ud_str, "_", nb_rnd_feat, "_max")
    feats_filename = paste0("feats_", prefix3, ".xlsx")
    print(feats_filename)
    feats_max = mread.xlsx (feats_filename)
    
    tmp= list(
      ud_str=ud_str,
      #gse=gse,
      nb_genes_mean = sum(feats_mean$methplusplus),
      nb_genes_max = sum(feats_max$methplusplus),
      common_genes = length(intersect(rownames(feats_mean)[feats_mean[["methplusplus"]]],rownames(feats_max)[feats_max[["methplusplus"]]]))
    )
    
    inter = rbind(inter, tmp)
  }
  
#}

```

```{r, echo=FALSE, results="verbatim", eval=FALSE}
knitr::kable(inter)
```

